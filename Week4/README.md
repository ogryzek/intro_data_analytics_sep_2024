# Week 4  
- [11. Common Table Expressions](#11-common-table-expressions) 
- [12. Data Retrieval](#12-data-retieval)

## 11. Common Table Expressions  
### Part 1: CTE (Common Table Expressions)  
  
1. Write a query that defines a CTE named `"Sales_CTE"`, which is based on the `OrderHeader` table, and contains the following columns:  Order Number, SalesPersonID, the year in which the order was placed.  

  Analyze only the data that has a value in the SalesPersonID column. Use the CTE you defined, and write a query that shows the amount of orders that each salesperson generated each year. 
  
  Sort the query results by SalesPersonID and year.  
  
  Note: With the results of the query, it is possible to evaluate the salespeople's performance, and see whether the salesperson improved their performance or it needs to be strengthened.  
  
  In addition, take into account when examining the results that data is not provided for all the months in 2011 and 2014.

2. Write a query that shows the average number of orders for all the years, for all the sales people. Analyze only the data that has a value in the SalesPersonID column:  
  a. Define a CTE named "Sales_CTE", which is based on the Order header table, and contains the following columnsSalesPersonID, the amount of orders generated by the salesperson.  
  b. WriteaquerybasedontheCTEthatdisplaystheaverageorderquantityof all the salespeople.  
    
3. WriteaquerythatdefinesaCTEnamed"Person_CTE",whichisbasedonthe Sales.Customer and Person.Person tables and contains the following columns: CustomerID, first name and last name.  
  
  The purpose of the CTE is to make it easier for us to link the Sales.SalesOrderHeader table to the Person.Person table.  
  
  Use the Order header table and the Person_CTE that you defined to write a query that displays the order number, customer number, first name, last name, and SubTotal.

4. Write a query that displays the amount of orders per product color in 2013,sorted from highest to lowest. Use a CTE to simplify the query:  

  a. Define a CTE named "Sales_CTE", which contains the following columns: Order number, OrderDate, ProductID and OrderQty.  
  
  b. UsetheCTEandtheProducttabletodisplaytheamountofordersper product color in 2013, sorted from highest to lowest  
  
  c. Note: The query could also be solved without using a CTE. However, it helps to keep the code clean, tidy and legible when splitting the queries into parts.  
    
### Part 2: Multiple CTE's (Common Table Expressions) 

1. In order to prepare an annual order report by customer, which includes both the customer's details and the summarized sales data, proceed according to the following instructions:
  a. Define a `Person_CTE`, based on the `Sales.Customer` and `Person.Person` tables, which displays the following columns: `CustomerID`, `First name`, and `Last name`.
  b. Define a `Sales_CTE` that compiles the number of orders and SubTotals for each year and customer, in the following columns: `CustomerID`, `Year`, `Total order quantity` and `SubTotal`.
  c. Join between the two CTEs you created in the two preceding sections. Display only the data for 2012.
  d. A point to consider: Where should the filter to display only 2012 data be placed â€“ in the query or in the CTE?

2. In order to compare the quantity of items offered and the quantity ordered for each color, write a query that displays the product color, the quantity of units of each color ordered, the quantity of order rows per color, and the quantity of items of each color offered in the Products table.
  Instruction:
    e. Define a CTE that is based on the `Orderdetails` and `Products` tables and contains the following columns: color, total order quantity and quantity of order rows.  
    f. Define a CTE that is based on the Products table only and contains the following columns: color, quantity of products per color.
    g. Use the two CTEs you defined, and display the following columns for all the colors (i.e., without colorless products): color, total order quantity, total orders, and quantity of products of this color in the Products table.
 
## 12. Data Retieval  
